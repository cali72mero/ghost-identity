<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ•µï¸ Ghost Identity | v2.3</title>
    <style>
        :root {
            --primary: #10b981;
            --primary-glow: #059669;
            --bg-dark: #0f172a;
            --bg-panel: #1e293b;
            --text: #f8fafc;
            --text-dim: #94a3b8;
            --border: #334155;
            --danger: #ef4444;
            --accent: #3b82f6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }

        .container { max-width: 1000px; margin: 0 auto; }

        header {
            text-align: center;
            padding: 40px 0;
            border-bottom: 1px solid var(--border);
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(16, 185, 129, 0.3);
        }

        .subtitle { color: var(--text-dim); font-size: 1.1rem; }
        .version-badge { 
            background: rgba(59, 130, 246, 0.2); color: var(--accent); 
            padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; border: 1px solid var(--accent);
            vertical-align: middle; margin-left: 10px;
        }

        /* Controls */
        .controls {
            background: var(--bg-panel);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--border);
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .control-group label { display: block; margin-bottom: 8px; color: var(--text-dim); font-size: 0.9rem; }
        select, input { width: 100%; padding: 10px; background: var(--bg-dark); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 1rem; }
        input[type="number"] { -moz-appearance: textfield; }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary { background: var(--primary); color: var(--bg-dark); width: 100%; font-size: 1.1rem; }
        .btn-primary:hover { background: var(--primary-glow); box-shadow: 0 0 20px rgba(16, 185, 129, 0.4); }
        
        .btn-action { background: var(--accent); color: white; }
        .btn-action:hover { background: #2563eb; }
        
        .btn-danger { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .btn-secondary { background: var(--bg-panel); border: 1px solid var(--border); color: var(--text); }
        .btn-test { background: var(--primary); color: var(--bg-dark); border: none; padding: 5px 10px; font-size: 0.8rem; font-weight: bold; }
        .btn-refresh { background: var(--accent); color: white; border: none; padding: 5px 10px; font-size: 0.8rem; }
        .btn-delete-mail { background: transparent; color: var(--danger); border: 1px solid var(--danger); padding: 5px 10px; font-size: 0.8rem; border-radius: 5px; cursor: pointer; }
        .btn-delete-mail:hover { background: rgba(239, 68, 68, 0.1); }

        /* Identity Card */
        .identity-card {
            background: var(--bg-panel);
            border-radius: 20px;
            border: 1px solid var(--border);
            overflow: hidden;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.4);
            transition: all 0.3s;
            margin-bottom: 30px;
        }

        .id-header {
            background: linear-gradient(90deg, var(--bg-dark), var(--bg-panel));
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .id-body { padding: 30px; display: grid; grid-template-columns: 150px 1fr; gap: 30px; }

        .avatar {
            width: 150px; height: 150px;
            background: var(--bg-dark); border-radius: 15px;
            display: flex; align-items: center; justify-content: center;
            font-size: 4rem; border: 2px solid var(--border);
            overflow: hidden;
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .info-item { position: relative; }
        .info-label { color: var(--text-dim); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        
        .info-value {
            font-size: 1.1rem; font-family: monospace;
            background: rgba(0,0,0,0.2); padding: 8px 12px;
            border-radius: 6px; border: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            cursor: pointer; transition: all 0.2s;
        }
        .info-value:hover { border-color: var(--primary); background: rgba(16, 185, 129, 0.1); }
        .info-value.loading { color: var(--text-dim); font-style: italic; }

        /* Inbox Styles */
        .inbox-section {
            background: var(--bg-panel);
            border-radius: 15px;
            border: 1px solid var(--border);
            overflow: hidden;
            margin-top: 20px;
            display: none;
        }

        .inbox-header {
            padding: 15px 20px;
            background: var(--bg-dark);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .inbox-actions { display: flex; gap: 10px; }
        .inbox-list { max-height: 400px; overflow-y: auto; }
        
        .email-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            position: relative;
            align-items: center;
        }
        .email-item:hover { background: var(--bg-dark); }
        .email-item.unread { border-left: 3px solid var(--primary); background: rgba(16, 185, 129, 0.05); }
        
        .email-content { display: grid; gap: 3px; }
        .email-from { font-weight: bold; color: var(--text); }
        .email-subject { color: var(--text-dim); font-size: 0.95rem; }
        .email-time { font-size: 0.8rem; color: var(--text-dim); }
        
        .otp-badge {
            display: inline-block;
            background: var(--primary); color: var(--bg-dark); 
            padding: 2px 8px; border-radius: 4px; font-weight: bold; font-family: monospace; font-size: 0.9rem;
            margin-left: 10px; vertical-align: middle;
        }

        .email-view { padding: 20px; background: var(--bg-dark); display: none; }
        .email-view-header { border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 15px; }
        .email-body { line-height: 1.6; white-space: pre-wrap; font-family: sans-serif; }
        
        .live-dot { width: 10px; height: 10px; background: var(--danger); border-radius: 50%; display: inline-block; margin-right: 5px; }
        .live-dot.active { background: var(--success); box-shadow: 0 0 10px var(--success); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Saved Section */
        .saved-section { margin-top: 40px; }
        .management-bar {
            background: var(--bg-panel); padding: 20px; border-radius: 15px;
            border: 1px solid var(--border); margin-bottom: 20px;
            display: flex; flex-wrap: wrap; gap: 15px; justify-content: space-between; align-items: center;
        }
        .saved-list { display: grid; gap: 15px; }
        .saved-item {
            background: var(--bg-panel); padding: 20px; border-radius: 10px; border: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center; transition: transform 0.2s;
        }
        .saved-item:hover { transform: translateX(5px); border-color: var(--primary); }
        .saved-info strong { display: block; font-size: 1.1rem; margin-bottom: 5px; color: var(--primary); }
        .saved-meta { font-size: 0.9rem; color: var(--text-dim); display: flex; gap: 15px; }
        
        /* Modal */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: var(--bg-panel); padding: 30px; border-radius: 15px; border: 1px solid var(--primary); max-width: 400px; width: 90%; text-align: center; }
        .modal input { margin: 15px 0; }

        .toast {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: var(--primary); color: var(--bg-dark); padding: 10px 20px;
            border-radius: 25px; font-weight: 600; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 1000;
        }

        @media (max-width: 768px) {
            .id-body { grid-template-columns: 1fr; text-align: center; }
            .avatar { margin: 0 auto; }
            .info-grid { grid-template-columns: 1fr; text-align: left; }
            .management-bar { flex-direction: column; align-items: stretch; }
            .saved-item { flex-direction: column; gap: 15px; align-items: flex-start; }
            .saved-item > div:last-child { width: 100%; display: flex; justify-content: space-between; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ•µï¸ Ghost Identity <span class="version-badge">v2.3</span></h1>
            <p class="subtitle">Next-Gen Identity Generator & Secure Mail Client</p>
            <div style="margin-top: 15px; font-size: 0.9rem; color: var(--text-dim);">
                ğŸ›¡ï¸ AES-256 Backups â€¢ ğŸ“¥ E-Mail Archiv â€¢ âš¡ Auto-2FA
            </div>
        </header>

        <!-- Generator Controls -->
        <div class="controls">
            <div class="control-group">
                <label>ğŸŒ Land / Region</label>
                <select id="country">
                    <option value="de">ğŸ‡©ğŸ‡ª Deutschland</option>
                    <option value="us">ğŸ‡ºğŸ‡¸ USA</option>
                    <option value="gb">ğŸ‡¬ğŸ‡§ UK</option>
                    <option value="fr">ğŸ‡«ğŸ‡· Frankreich</option>
                    <option value="jp">ğŸ‡¯ğŸ‡µ Japan</option>
                </select>
            </div>
            <div class="control-group">
                <label>ğŸš» Geschlecht</label>
                <select id="gender">
                    <option value="random">ğŸ² ZufÃ¤llig</option>
                    <option value="male">ğŸ‘¨ MÃ¤nnlich</option>
                    <option value="female">ğŸ‘© Weiblich</option>
                </select>
            </div>
            <div class="control-group">
                <label>ğŸ“… Alter (14-80)</label>
                <select id="ageRange" onchange="toggleCustomAge()">
                    <option value="14-18" selected>14 - 18 (Teenager)</option>
                    <option value="18-30">18 - 30 (Erwachsen)</option>
                    <option value="30-50">30 - 50 (Mittelalter)</option>
                    <option value="50-70">50 - 70 (Senior)</option>
                    <option value="manual">âœï¸ Manuelles Alter...</option>
                </select>
                <input type="number" id="customAge" placeholder="Alter eingeben" min="14" max="80" style="display: none; margin-top: 5px;">
            </div>
            <div style="display: flex; align-items: end;">
                <button class="btn btn-primary" onclick="generateIdentity()">
                    ğŸ² Generieren
                </button>
            </div>
        </div>

        <!-- Identity Card View -->
        <div id="identityCard" class="identity-card" style="display: none;">
            <div class="id-header">
                <div style="font-weight: bold; letter-spacing: 2px;">IDENTITÃ„TS-KARTE</div>
                <div class="country-flag" id="displayFlag">ğŸ‡©ğŸ‡ª</div>
            </div>
            <div class="id-body">
                <div class="avatar" id="avatar"></div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">VollstÃ¤ndiger Name</div>
                        <div class="info-value" onclick="copyText(this)">
                            <span id="fullName">-</span>
                            <span class="copy-icon">ğŸ“‹</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Geburtsdatum</div>
                        <div class="info-value" onclick="copyText(this)">
                            <span id="birthDate">-</span>
                            <span class="copy-icon">ğŸ“‹</span>
                        </div>
                    </div>
                    <div class="info-item" style="grid-column: span 2;">
                        <div class="info-label">Adresse</div>
                        <div class="info-value" onclick="copyText(this)">
                            <span id="address">-</span>
                            <span class="copy-icon">ğŸ“‹</span>
                        </div>
                    </div>
                    <div class="info-item" style="grid-column: span 2;">
                        <div class="info-label">E-Mail (Echter Empfang mÃ¶glich!)</div>
                        <div class="info-value" onclick="copyText(this)">
                            <span id="email">Wird generiert...</span>
                            <span class="copy-icon">ğŸ“‹</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Benutzername</div>
                        <div class="info-value" onclick="copyText(this)">
                            <span id="username">-</span>
                            <span class="copy-icon">ğŸ“‹</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Passwort</div>
                        <div class="info-value" onclick="copyText(this)">
                            <span id="password">-</span>
                            <span class="copy-icon">ğŸ“‹</span>
                        </div>
                    </div>
                    <div class="info-item" style="grid-column: span 2;">
                        <div class="info-label">IBAN (Zufall)</div>
                        <div class="info-value" onclick="copyText(this)">
                            <span id="iban">-</span>
                            <span class="copy-icon">ğŸ“‹</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Inbox Section -->
            <div class="inbox-section" id="inboxSection">
                <div class="inbox-header">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="live-dot active"></span>
                        <strong>Posteingang</strong> <span id="mailCount" style="font-size: 0.8rem; color: var(--text-dim);">(0)</span>
                    </div>
                    <div class="inbox-actions">
                        <button class="btn btn-test" onclick="sendTestMail()">ğŸ“¨ Test</button>
                        <button class="btn btn-refresh" onclick="checkMail()">ğŸ”„</button>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.8rem;" onclick="clearInbox()">ğŸ—‘ï¸</button>
                    </div>
                </div>
                <div class="inbox-list" id="inboxList">
                    <div style="padding: 20px; text-align: center; color: var(--text-dim);">
                        Warte auf E-Mails... (Auto-Refresh alle 5s)
                    </div>
                </div>
                <div class="email-view" id="emailView">
                    <button class="btn btn-secondary" style="margin-bottom: 15px;" onclick="closeEmail()">â¬…ï¸ ZurÃ¼ck</button>
                    <div class="email-view-header">
                        <h3 id="viewSubject">Betreff</h3>
                        <div id="viewFrom" style="color: var(--text-dim); margin-top: 5px;">Von: -</div>
                    </div>
                    <div class="email-body" id="viewBody"></div>
                </div>
            </div>

            <!-- Save Button -->
            <div style="padding: 20px; background: rgba(0,0,0,0.2); text-align: center; border-top: 1px solid var(--border);">
                <button class="btn btn-primary" onclick="saveCurrentIdentity()" style="width: auto;">
                    ğŸ’¾ IdentitÃ¤t & E-Mail Verlauf speichern
                </button>
            </div>
        </div>

        <!-- Saved Identities Manager -->
        <div class="saved-section">
            <div class="management-bar">
                <h2 style="font-size: 1.5rem;">ğŸ“‚ Gespeicherte IdentitÃ¤ten (<span id="savedCount">0</span>)</h2>
                
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-action" onclick="showExportModal()">ğŸ” Backup Exportieren</button>
                    <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()">ğŸ“¥ Backup Laden</button>
                    <input type="file" id="importFile" style="display: none;" onchange="importData(event)" accept=".json">
                    <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ Alles LÃ¶schen</button>
                </div>
            </div>
            <div id="savedList" class="saved-list"></div>
        </div>
    </div>

    <!-- Modals -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ” Backup VerschlÃ¼sseln</h3>
            <p style="color: var(--text-dim); font-size: 0.9rem;">Optional: Gib ein Passwort ein, um deine Daten sicher mit AES-256 zu verschlÃ¼sseln.</p>
            <input type="password" id="exportPass" placeholder="Passwort (Optional)">
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn btn-secondary" onclick="closeModal('exportModal')">Abbrechen</button>
                <button class="btn btn-primary" onclick="performExport()">Exportieren</button>
            </div>
        </div>
    </div>
    <div id="importModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ”“ Backup EntschlÃ¼sseln</h3>
            <p style="color: var(--text-dim); font-size: 0.9rem;">Dieses Backup ist verschlÃ¼sselt. Bitte Passwort eingeben.</p>
            <input type="password" id="importPass" placeholder="Passwort">
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button class="btn btn-secondary" onclick="closeModal('importModal')">Abbrechen</button>
                <button class="btn btn-primary" onclick="performImport()">EntschlÃ¼sseln</button>
            </div>
        </div>
    </div>
    <div id="toast" class="toast">âœ… Kopiert!</div>

    <script>
        // EXPANDED DATA POOLS FOR BETTER RANDOMNESS
        const data = {
            de: {
                firstNamesMale: ["Max", "Paul", "Leon", "Lukas", "Felix", "Jonas", "Elias", "Tim", "Jan", "Niklas", "Ben", "Luis", "Finn", "Noah", "Jakob", "Moritz", "Julian", "Philipp", "David", "Alexander", "Tom", "Simon", "Erik", "Anton", "Maximilian", "Fabian", "Hannes", "Leo", "Mats", "Lenny", "Oskar", "Theo", "Liam", "Marlon", "Emil", "Henry", "Samuel", "Johann", "Valentin", "Vincent"],
                firstNamesFemale: ["Mia", "Emma", "Sofia", "Hannah", "Anna", "Lea", "Lena", "Marie", "Laura", "Julia", "Emilia", "Lina", "Mila", "Sophie", "Clara", "Lara", "Luisa", "Johanna", "Mathilda", "Nele", "Frieda", "Ida", "Lotte", "Amelie", "Maja", "Ella", "Charlotte", "Paula", "Lilly", "Greta", "Lisa", "Melina", "Zoe", "Mara", "Elena", "Sarah", "Jana", "Mira", "Pia", "Viktoria"],
                lastNames: ["MÃ¼ller", "Schmidt", "Schneider", "Fischer", "Weber", "Meyer", "Wagner", "Becker", "Schulz", "Hoffmann", "SchÃ¤fer", "Koch", "Bauer", "Richter", "Klein", "Wolf", "SchrÃ¶der", "Neumann", "Schwarz", "Zimmermann", "Braun", "KrÃ¼ger", "Hofmann", "Hartmann", "Lange", "Schmitt", "Werner", "Schmitz", "Krause", "Meier", "Lehmann", "Schmid", "Schulze", "Maier", "KÃ¶hler", "Herrmann", "KÃ¶nig", "Walter", "Mayer", "Huber"],
                cities: ["Berlin", "Hamburg", "MÃ¼nchen", "KÃ¶ln", "Frankfurt", "Stuttgart", "DÃ¼sseldorf", "Leipzig", "Dortmund", "Essen", "Bremen", "Dresden", "Hannover", "NÃ¼rnberg", "Duisburg", "Bochum", "Wuppertal", "Bielefeld", "Bonn", "MÃ¼nster", "Karlsruhe", "Mannheim", "Augsburg", "Wiesbaden", "MÃ¶nchengladbach"],
                streets: ["HauptstraÃŸe", "BahnhofstraÃŸe", "SchulstraÃŸe", "GartenstraÃŸe", "DorfstraÃŸe", "BergstraÃŸe", "LindenstraÃŸe", "KirchstraÃŸe", "RingstraÃŸe", "WaldstraÃŸe", "FeldstraÃŸe", "WiesenstraÃŸe", "SchillerstraÃŸe", "GoethestraÃŸe", "MozartstraÃŸe", "JahnstraÃŸe", "Birkenweg", "Ahornweg", "Eichenweg", "Buchenweg"]
            },
            us: {
                firstNamesMale: ["James", "John", "Robert", "Michael", "William", "David", "Richard", "Joseph", "Thomas", "Charles", "Christopher", "Daniel", "Matthew", "Anthony", "Mark", "Donald", "Steven", "Paul", "Andrew", "Joshua", "Kenneth", "Kevin", "Brian", "George", "Edward", "Ronald", "Timothy", "Jason", "Jeffrey", "Ryan"],
                firstNamesFemale: ["Mary", "Patricia", "Jennifer", "Linda", "Elizabeth", "Barbara", "Susan", "Jessica", "Sarah", "Karen", "Nancy", "Lisa", "Betty", "Margaret", "Sandra", "Ashley", "Kimberly", "Emily", "Donna", "Michelle", "Dorothy", "Carol", "Amanda", "Melissa", "Deborah", "Stephanie", "Rebecca", "Sharon", "Laura", "Cynthia"],
                lastNames: ["Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", "Miller", "Davis", "Rodriguez", "Martinez", "Hernandez", "Lopez", "Gonzalez", "Wilson", "Anderson", "Thomas", "Taylor", "Moore", "Jackson", "Martin", "Lee", "Perez", "Thompson", "White", "Harris", "Sanchez", "Clark", "Ramirez", "Lewis", "Robinson"],
                cities: ["New York", "Los Angeles", "Chicago", "Houston", "Phoenix", "Philadelphia", "San Antonio", "San Diego", "Dallas", "San Jose", "Austin", "Jacksonville", "Fort Worth", "Columbus", "Charlotte", "San Francisco", "Indianapolis", "Seattle", "Denver", "Washington", "Boston", "El Paso", "Nashville", "Detroit", "Oklahoma City"],
                streets: ["Main St", "Broadway", "Maple Ave", "Oak St", "Washington St", "Park Ave", "Elm St", "Cedar St", "Pine St", "Lakeview Dr", "Highland Ave", "Sunset Blvd", "River Rd", "Forest Ln", "Hillside Dr", "Church St", "2nd St", "4th St", "6th Ave", "8th St"]
            },
            gb: {
                firstNamesMale: ["Oliver", "George", "Harry", "Jack", "Jacob", "Noah", "Charlie", "Muhammad", "Thomas", "Oscar", "William", "James", "Henry", "Leo", "Alfie", "Joshua", "Freddie", "Archie", "Ethan", "Isaac", "Alexander", "Joseph", "Edward", "Samuel", "Max", "Daniel", "Arthur", "Lucas", "Mohammed", "Logan"],
                firstNamesFemale: ["Olivia", "Amelia", "Isla", "Ava", "Emily", "Isabella", "Mia", "Poppy", "Ella", "Lily", "Sophia", "Grace", "Sophie", "Freya", "Alice", "Florence", "Charlotte", "Daisy", "Sienna", "Phoebe", "Evie", "Ruby", "Millie", "Evelyn", "Ivy", "Harper", "Matilda", "Rosie", "Elsie", "Sofia"],
                lastNames: ["Smith", "Jones", "Taylor", "Brown", "Williams", "Wilson", "Johnson", "Davies", "Robinson", "Wright", "Thompson", "Evans", "Walker", "White", "Roberts", "Green", "Hall", "Wood", "Harris", "Clarke", "Patel", "Jackson", "Khan", "Lewis", "Hughes", "Edwards", "Turner", "Martin", "Ward", "Cooper"],
                cities: ["London", "Manchester", "Birmingham", "Leeds", "Glasgow", "Southampton", "Liverpool", "Newcastle", "Nottingham", "Sheffield", "Bristol", "Belfast", "Leicester", "Edinburgh", "Cardiff", "Coventry", "Bradford", "Hull", "Stoke-on-Trent", "Wolverhampton"],
                streets: ["High Street", "Station Road", "London Road", "Church Street", "Main Street", "Park Road", "Victoria Road", "Queens Road", "New Road", "Manor Road", "Church Lane", "Mill Lane", "The Avenue", "West Street", "North Street", "School Lane", "Springfield Road", "York Road", "King Street", "George Street"]
            },
            fr: {
                firstNamesMale: ["Gabriel", "Leo", "Raphael", "Arthur", "Louis", "Lucas", "Adam", "Jules", "Hugo", "MaÃ«l", "Liam", "Noah", "Paul", "Ethan", "Tiago", "Sacha", "Gabin", "Nathan", "Mohamed", "Aaron"],
                firstNamesFemale: ["Jade", "Louise", "Emma", "Alice", "Ambre", "Lina", "Rose", "ChloÃ©", "Mia", "LÃ©a", "Julia", "Mila", "InÃ¨s", "Anna", "Elena", "Romane", "ZoÃ©", "Agathe", "Juliette", "LÃ©na"],
                lastNames: ["Martin", "Bernard", "Thomas", "Petit", "Robert", "Richard", "Durand", "Dubois", "Moreau", "Laurent", "Simon", "Michel", "Lefebvre", "Leroy", "Roux", "David", "Bertrand", "Morel", "Fournier", "Girard"],
                cities: ["Paris", "Marseille", "Lyon", "Toulouse", "Nice", "Nantes", "Strasbourg", "Montpellier", "Bordeaux", "Lille", "Rennes", "Reims", "Le Havre", "Saint-Ã‰tienne", "Toulon"],
                streets: ["Rue de la Paix", "Avenue des Champs-Ã‰lysÃ©es", "Rue de la RÃ©publique", "Grande Rue", "Rue du Moulin", "Place de la Mairie", "Rue du ChÃ¢teau", "Rue des Ã‰coles", "Rue de l'Ã‰glise", "Rue Pasteur", "Rue Victor Hugo"]
            },
            jp: {
                firstNamesMale: ["Haruto", "Riku", "Sora", "Ren", "Hiroto", "Yuto", "Sota", "Minato", "Yuma", "Kaito", "Kota", "Tatsuki", "Daiki", "Sho", "Kenta", "Takumi", "Kazuki", "Ryota", "Hayato", "Yuki"],
                firstNamesFemale: ["Yui", "Rio", "Hina", "Mei", "Sakura", "Rin", "Aoi", "Himari", "Akari", "Yuna", "Mio", "Haruka", "Misaki", "Nanami", "Kanna", "Koharu", "Suzu", "Noa", "Kokona", "Ayaka"],
                lastNames: ["Sato", "Suzuki", "Takahashi", "Tanaka", "Watanabe", "Ito", "Yamamoto", "Nakamura", "Kobayashi", "Kato", "Yoshida", "Yamada", "Sasaki", "Yamaguchi", "Matsumoto", "Inoue", "Kimura", "Hayashi", "Shimizu", "Yamazaki"],
                cities: ["Tokyo", "Osaka", "Kyoto", "Yokohama", "Nagoya", "Sapporo", "Fukuoka", "Kobe", "Kawasaki", "Saitama", "Hiroshima", "Sendai", "Chiba", "Kitakyushu", "Sakai"],
                streets: ["Chuo-dori", "Showa-dori", "Meiji-dori", "Yasukuni-dori", "Aoyama-dori", "Omotesando", "Takeshita-dori", "Kokusai-dori", "Heiwa-dori"]
            }
        };

        let currentIdentity = null;
        let savedIdentities = JSON.parse(localStorage.getItem('ghost_identities') || '[]');
        let mailToken = null;
        let pollInterval = null;
        let pendingImportData = null;
        let currentMessages = [];

        // --- Crypto Utils (AES-GCM) ---
        async function encryptData(data, password) {
            const enc = new TextEncoder();
            const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password), {name: "PBKDF2"}, false, ["deriveKey"]);
            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            const key = await window.crypto.subtle.deriveKey({name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256"}, keyMaterial, {name: "AES-GCM", length: 256}, false, ["encrypt"]);
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const content = enc.encode(JSON.stringify(data));
            const encrypted = await window.crypto.subtle.encrypt({name: "AES-GCM", iv: iv}, key, content);
            const buffer = new Uint8Array(salt.byteLength + iv.byteLength + encrypted.byteLength);
            buffer.set(salt, 0); buffer.set(iv, salt.byteLength); buffer.set(new Uint8Array(encrypted), salt.byteLength + iv.byteLength);
            return btoa(String.fromCharCode(...buffer));
        }

        async function decryptData(base64Data, password) {
            try {
                const enc = new TextEncoder();
                const combined = new Uint8Array(atob(base64Data).split("").map(c => c.charCodeAt(0)));
                const salt = combined.slice(0, 16); const iv = combined.slice(16, 28); const data = combined.slice(28);
                const keyMaterial = await window.crypto.subtle.importKey("raw", enc.encode(password), {name: "PBKDF2"}, false, ["deriveKey"]);
                const key = await window.crypto.subtle.deriveKey({name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256"}, keyMaterial, {name: "AES-GCM", length: 256}, false, ["decrypt"]);
                const decrypted = await window.crypto.subtle.decrypt({name: "AES-GCM", iv: iv}, key, data);
                return JSON.parse(new TextDecoder().decode(decrypted));
            } catch (e) { throw new Error("Falsches Passwort oder beschÃ¤digte Datei"); }
        }

        // --- Generators ---
        function generateIBAN(country) {
            const prefix = country.toUpperCase();
            return `${prefix}89 ${Math.floor(Math.random()*9999)} ${Math.floor(Math.random()*9999)} ${Math.floor(Math.random()*9999)} ${Math.floor(Math.random()*9999)}`;
        }

        const MailService = {
            baseUrl: 'https://api.mail.tm',
            async getDomain() { const res = await fetch(`${this.baseUrl}/domains`); const data = await res.json(); return data['hydra:member'][0].domain; },
            async createAccount(address, password) {
                const res = await fetch(`${this.baseUrl}/accounts`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ address, password }) });
                return res.ok;
            },
            async getToken(address, password) {
                const res = await fetch(`${this.baseUrl}/token`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ address, password }) });
                const data = await res.json(); if(!data.token) throw new Error("Kein Token"); return data.token;
            },
            async getMessages(token) {
                const res = await fetch(`${this.baseUrl}/messages?page=1`, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json(); return data['hydra:member'];
            },
            async getMessage(token, id) {
                 const res = await fetch(`${this.baseUrl}/messages/${id}`, { headers: { 'Authorization': `Bearer ${token}` } });
                return await res.json();
            }
        };

        function getRandom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

        function toggleCustomAge() {
            const val = document.getElementById('ageRange').value;
            const input = document.getElementById('customAge');
            input.style.display = val === 'manual' ? 'block' : 'none';
        }

        async function generateIdentity() {
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = null; mailToken = null; currentMessages = [];

            const country = document.getElementById('country').value;
            const genderSelect = document.getElementById('gender').value;
            const ageRange = document.getElementById('ageRange').value;
            
            const pool = data[country];
            let gender = genderSelect === 'random' ? (Math.random() > 0.5 ? 'male' : 'female') : genderSelect;
            
            const firstName = gender === 'male' ? getRandom(pool.firstNamesMale) : getRandom(pool.firstNamesFemale);
            const lastName = getRandom(pool.lastNames);
            const city = getRandom(pool.cities);
            const street = getRandom(pool.streets);
            const houseNum = Math.floor(Math.random() * 150) + 1;
            const zip = Math.floor(10000 + Math.random() * 90000);
            
            // Age Logic
            let age;
            if (ageRange === 'manual') {
                const inputVal = parseInt(document.getElementById('customAge').value);
                age = (inputVal >= 14 && inputVal <= 80) ? inputVal : 18; // Default fallback
            } else {
                const [minAge, maxAge] = ageRange.split('-').map(Number);
                age = Math.floor(Math.random() * (maxAge - minAge + 1)) + minAge;
            }
            
            const year = new Date().getFullYear() - age;
            const birthDate = `${Math.floor(Math.random()*28)+1}.${Math.floor(Math.random()*12)+1}.${year}`;

            const cleanName = firstName.toLowerCase() + lastName.toLowerCase();
            let username = `${cleanName}${year % 100}`;
            
            // DUPLICATE CHECK
            let attempt = 0;
            const originalUser = username;
            while (savedIdentities.some(id => id.username === username) && attempt < 50) {
                username = `${originalUser}${Math.floor(Math.random()*999)}`;
                attempt++;
            }

            const password = generatePassword(); 
            const iban = generateIBAN(country);

            currentIdentity = {
                id: Date.now(),
                firstName, lastName, gender, country,
                address: `${street} ${houseNum}, ${zip} ${city}`,
                birthDate, age, username, password,
                iban: iban,
                email: "Erstelle E-Mail...",
                createdAt: new Date().toISOString(),
                savedEmails: [] // NEW: Store emails
            };
            
            updateUI(currentIdentity);
            document.getElementById('email').classList.add('loading');
            
            try {
                const domain = await MailService.getDomain();
                const emailAddress = `${username}${Math.floor(Math.random()*9999)}@${domain}`;
                
                const created = await MailService.createAccount(emailAddress, password);
                if (created) {
                    mailToken = await MailService.getToken(emailAddress, password);
                    currentIdentity.email = emailAddress;
                    currentIdentity.mailToken = mailToken; 
                    
                    document.getElementById('email').textContent = emailAddress;
                    document.getElementById('email').classList.remove('loading');
                    document.getElementById('inboxSection').style.display = 'block';
                    renderInbox([]);
                    startPolling();
                } else {
                    document.getElementById('email').textContent = "Fehler bei E-Mail Erstellung";
                }
            } catch (e) {
                console.error(e);
                document.getElementById('email').textContent = "API Fehler (mail.tm)";
            }
        }

        function generatePassword() {
            const chars = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*";
            let pass = "";
            for (let i = 0; i < 16; i++) pass += chars.charAt(Math.floor(Math.random() * chars.length));
            return pass;
        }

        function updateUI(id) {
            document.getElementById('identityCard').style.display = 'block';
            document.getElementById('displayFlag').textContent = { de: 'ğŸ‡©ğŸ‡ª', us: 'ğŸ‡ºğŸ‡¸', gb: 'ğŸ‡¬ğŸ‡§', fr: 'ğŸ‡«ğŸ‡·', jp: 'ğŸ‡¯ğŸ‡µ' }[id.country] || 'ğŸŒ';
            const avatarUrl = `https://api.dicebear.com/7.x/avataaars/svg?seed=${id.username}&gender=${id.gender}`;
            document.getElementById('avatar').innerHTML = `<img src="${avatarUrl}" alt="Avatar">`;
            document.getElementById('fullName').textContent = `${id.firstName} ${id.lastName}`;
            document.getElementById('birthDate').textContent = `${id.birthDate} (${id.age} Jahre)`;
            document.getElementById('address').textContent = id.address;
            document.getElementById('email').textContent = id.email;
            document.getElementById('username').textContent = id.username;
            document.getElementById('password').textContent = id.password;
            document.getElementById('iban').textContent = id.iban || '-';
        }

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);
            checkMail();
            pollInterval = setInterval(checkMail, 5000);
        }

        async function checkMail() {
            if (!mailToken || !currentIdentity) return;
            try {
                const newMessages = await MailService.getMessages(mailToken);
                if (newMessages.length > 0) {
                    // Merge new messages with saved ones, avoiding duplicates
                    const savedIds = new Set(currentIdentity.savedEmails.map(m => m.id));
                    let hasNew = false;
                    
                    for (const msg of newMessages) {
                        if (!savedIds.has(msg.id)) {
                            // Fetch full content immediately to save it
                            const fullMsg = await MailService.getMessage(mailToken, msg.id);
                            currentIdentity.savedEmails.unshift(fullMsg);
                            hasNew = true;
                        }
                    }
                    if (hasNew) {
                        saveCurrentIdentity(false); // Silent save
                        renderInbox(currentIdentity.savedEmails);
                    }
                }
            } catch (e) { console.log("Polling error", e); }
        }

        async function sendTestMail() {
            if (!currentIdentity) return;
            const fakeMsg = {
                id: 'test-' + Date.now(),
                from: { name: 'Ghost System', address: 'security@ghost.local' },
                subject: 'âœ… Dein Sicherheitscode: 4829',
                intro: 'Code: 4829',
                text: 'Dein Code ist: 4829',
                createdAt: new Date().toISOString(),
                seen: false
            };
            currentIdentity.savedEmails.unshift(fakeMsg);
            saveCurrentIdentity(false);
            renderInbox(currentIdentity.savedEmails);
        }

        function extractOTP(text) {
            const codeMatch = text.match(/(?:code|pin|verification|verifizierung|nummer)[:\s]+([0-9]{4,8})/i);
            if (codeMatch) return codeMatch[1];
            const numberMatch = text.match(/\b\d{4,8}\b/);
            return numberMatch ? numberMatch[0] : null;
        }

        function renderInbox(messages) {
            const list = document.getElementById('inboxList');
            document.getElementById('mailCount').textContent = `(${messages.length})`;
            list.innerHTML = '';
            
            if (messages.length === 0) { 
                list.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-dim);">Keine Nachrichten.</div>'; 
                return; 
            }
            
            messages.forEach((msg, index) => {
                const otp = extractOTP(msg.intro || msg.subject || msg.text || "");
                const div = document.createElement('div');
                div.className = `email-item ${!msg.seen ? 'unread' : ''}`;
                
                let html = `
                    <div class="email-content" onclick="openEmail(${index})">
                        <div class="email-from">${msg.from.name || msg.from.address} 
                            ${otp ? `<span class="otp-badge">${otp}</span>` : ''}
                        </div>
                        <div class="email-subject">${msg.subject || '(Kein Betreff)'}</div>
                        <div class="email-time">${new Date(msg.createdAt).toLocaleString()}</div>
                    </div>
                    <button class="btn-delete-mail" onclick="deleteEmail(${index})" title="LÃ¶schen">âŒ</button>
                `;
                div.innerHTML = html;
                list.appendChild(div);
            });
        }

        function openEmail(index) {
            if (!currentIdentity || !currentIdentity.savedEmails[index]) return;
            const msg = currentIdentity.savedEmails[index];
            
            const list = document.getElementById('inboxList');
            const view = document.getElementById('emailView');
            list.style.display = 'none'; view.style.display = 'block';
            
            document.getElementById('viewSubject').textContent = msg.subject;
            document.getElementById('viewFrom').textContent = `Von: ${msg.from.address} (${new Date(msg.createdAt).toLocaleString()})`;
            
            const otp = extractOTP(msg.text || "");
            let bodyContent = msg.text || msg.html || "Kein Inhalt.";
            // Highlight OTP
            if (otp) bodyContent = bodyContent.replace(otp, `<span style="background:var(--primary); color:black; padding:2px 5px; font-weight:bold; border-radius:3px;">${otp}</span>`);
            
            document.getElementById('viewBody').innerHTML = bodyContent;
            
            // Mark as seen
            if (!msg.seen) {
                msg.seen = true;
                saveCurrentIdentity(false);
                // Re-render list in background so it's updated when we go back
                // renderInbox(currentIdentity.savedEmails); 
            }
        }
        
        function deleteEmail(index) {
            if(!confirm("E-Mail wirklich lÃ¶schen?")) return;
            currentIdentity.savedEmails.splice(index, 1);
            saveCurrentIdentity(false);
            renderInbox(currentIdentity.savedEmails);
        }
        
        function clearInbox() {
            if(!confirm("Alle E-Mails dieser IdentitÃ¤t unwiderruflich lÃ¶schen?")) return;
            currentIdentity.savedEmails = [];
            saveCurrentIdentity(false);
            renderInbox([]);
        }

        function closeEmail() { 
            document.getElementById('inboxList').style.display = 'block'; 
            document.getElementById('emailView').style.display = 'none'; 
            renderInbox(currentIdentity.savedEmails); // Refresh to show 'read' status
        }
        
        function copyText(element) { navigator.clipboard.writeText(element.querySelector('span').textContent); showToast(); }
        function showToast() { const toast = document.getElementById('toast'); toast.style.opacity = '1'; setTimeout(() => toast.style.opacity = '0', 2000); }
        
        function saveCurrentIdentity(showAlert = true) {
            if (!currentIdentity) return;
            const exists = savedIdentities.some(id => id.id === currentIdentity.id);
            if (exists) { 
                const index = savedIdentities.findIndex(id => id.id === currentIdentity.id);
                if (mailToken) currentIdentity.mailToken = mailToken; 
                savedIdentities[index] = currentIdentity; 
                if (showAlert) alert('âœ… IdentitÃ¤t & Verlauf aktualisiert!');
            } else {
                if (mailToken) currentIdentity.mailToken = mailToken; 
                savedIdentities.unshift(currentIdentity); 
                if (showAlert) alert('âœ… IdentitÃ¤t lokal gespeichert!');
            }
            localStorage.setItem('ghost_identities', JSON.stringify(savedIdentities)); 
            renderSavedList();
        }
        
        function renderSavedList() {
            const list = document.getElementById('savedList'); document.getElementById('savedCount').textContent = savedIdentities.length; list.innerHTML = '';
            if (savedIdentities.length === 0) { list.innerHTML = '<div style="padding:20px; text-align:center; color:var(--text-dim)">Keine Daten.</div>'; return; }
            savedIdentities.forEach((id, index) => {
                const item = document.createElement('div'); item.className = 'saved-item';
                const flag = { de: 'ğŸ‡©ğŸ‡ª', us: 'ğŸ‡ºğŸ‡¸', gb: 'ğŸ‡¬ğŸ‡§', fr: 'ğŸ‡«ğŸ‡·', jp: 'ğŸ‡¯ğŸ‡µ' }[id.country] || 'ğŸŒ';
                const mailCount = id.savedEmails ? id.savedEmails.length : 0;
                item.innerHTML = `
                    <div class="saved-info">
                        <strong>${flag} ${id.firstName} ${id.lastName}</strong>
                        <div class="saved-meta">
                            <span>ğŸ“§ ${id.email}</span>
                            <span>ğŸ“¥ ${mailCount} Mails</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" style="padding: 10px 15px;" onclick="loadIdentity(${index})">Login ğŸš€</button>
                        <button class="btn btn-danger" style="padding: 10px 15px;" onclick="deleteIdentity(${index})">âŒ</button>
                    </div>`;
                list.appendChild(item);
            });
        }
        
        async function loadIdentity(index) {
            if (pollInterval) clearInterval(pollInterval); pollInterval = null;
            const id = savedIdentities[index]; 
            currentIdentity = id;
            if (!currentIdentity.savedEmails) currentIdentity.savedEmails = [];
            
            updateUI(id);
            renderInbox(currentIdentity.savedEmails);
            
            document.getElementById('email').classList.add('loading'); document.getElementById('email').textContent = "Verbinde mit Postfach...";
            try {
                if (id.mailToken) { mailToken = id.mailToken; }
                else { const token = await MailService.getToken(id.email, id.password); mailToken = token; id.mailToken = token; saveCurrentIdentity(false); }
                document.getElementById('email').textContent = id.email; document.getElementById('email').classList.remove('loading'); document.getElementById('inboxSection').style.display = 'block'; 
                
                // Initial check immediately
                checkMail();
                startPolling();
            } catch (e) { console.error("Login failed", e); document.getElementById('email').textContent = id.email + " (Nicht erreichbar - evtl. gelÃ¶scht)"; mailToken = null; document.getElementById('inboxSection').style.display = 'block'; /* Show saved mails even if offline */ }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        function deleteIdentity(index) { if (confirm('Wirklich lÃ¶schen?')) { savedIdentities.splice(index, 1); localStorage.setItem('ghost_identities', JSON.stringify(savedIdentities)); renderSavedList(); if (savedIdentities.length === 0) document.getElementById('identityCard').style.display = 'none'; } }
        function clearAllData() { if (confirm('âš ï¸ ACHTUNG: Das lÃ¶scht ALLE gespeicherten IdentitÃ¤ten vom Browser!')) { savedIdentities = []; currentIdentity = null; mailToken = null; localStorage.setItem('ghost_identities', '[]'); renderSavedList(); document.getElementById('identityCard').style.display = 'none'; } }
        function showExportModal() { if (savedIdentities.length === 0) { alert('Keine Daten!'); return; } document.getElementById('exportModal').style.display = 'flex'; }
        async function performExport() {
            const password = document.getElementById('exportPass').value; const backup = { version: "2.3", date: new Date().toISOString(), identities: savedIdentities };
            let dataStr; let filename = `ghost-backup-${new Date().toISOString().slice(0,10)}`;
            if (password) {
                try { const encrypted = await encryptData(backup, password); dataStr = JSON.stringify({ encrypted: true, content: encrypted }); filename += "-SECURE"; }
                catch (e) { alert("VerschlÃ¼sselungs-Fehler: " + e.message); return; }
            } else { dataStr = JSON.stringify(backup, null, 2); }
            const blob = new Blob([dataStr], { type: "application/json" }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename + ".json"; a.click(); URL.revokeObjectURL(url); closeModal('exportModal');
        }
        function importData(e) {
            const file = e.target.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = (ev) => {
                try { const json = JSON.parse(ev.target.result); if (json.encrypted) { pendingImportData = json.content; document.getElementById('importModal').style.display = 'flex'; } else { finishImport(json); } }
                catch (err) { alert("âŒ UngÃ¼ltige Datei!"); }
            }; reader.readAsText(file); e.target.value = '';
        }
        async function performImport() { const password = document.getElementById('importPass').value; try { const data = await decryptData(pendingImportData, password); finishImport(data); closeModal('importModal'); } catch (e) { alert("âŒ Falsches Passwort!"); } }
        function finishImport(json) {
            let newIdentities = []; if (Array.isArray(json)) newIdentities = json; else if (json.identities) newIdentities = json.identities;
            const existingIds = new Set(savedIdentities.map(i => i.id)); let addedCount = 0;
            newIdentities.forEach(id => { if (!existingIds.has(id.id)) { savedIdentities.push(id); addedCount++; } });
            localStorage.setItem('ghost_identities', JSON.stringify(savedIdentities)); renderSavedList(); alert(`âœ… Import erfolgreich! ${addedCount} neue IdentitÃ¤ten.`);
        }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; pendingImportData = null; document.getElementById('exportPass').value = ''; document.getElementById('importPass').value = ''; }
        window.addEventListener('load', renderSavedList);
    </script>
</body>
</html>